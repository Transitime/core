<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (version 1.7.0_25) on Thu Sep 11 10:18:50 PDT 2014 -->
<title>ScheduleDataProcessor</title>
<meta name="date" content="2014-09-11">
<link rel="stylesheet" type="text/css" href="../../../stylesheet.css" title="Style">
</head>
<body>
<script type="text/javascript"><!--
    if (location.href.indexOf('is-external=true') == -1) {
        parent.document.title="ScheduleDataProcessor";
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar_top">
<!--   -->
</a><a href="#skip-navbar_top" title="Skip navigation links"></a><a name="navbar_top_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/ScheduleDataProcessor.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../org/transitime/statistics/MiscStatistics.html" title="class in org.transitime.statistics"><span class="strong">Prev Class</span></a></li>
<li><a href="../../../org/transitime/statistics/ScheduleDataProcessor.TerminalDeparturesKey.html" title="class in org.transitime.statistics"><span class="strong">Next Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../index.html?org/transitime/statistics/ScheduleDataProcessor.html" target="_top">Frames</a></li>
<li><a href="ScheduleDataProcessor.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li><a href="#nested_class_summary">Nested</a>&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#constructor_summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method_summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#constructor_detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method_detail">Method</a></li>
</ul>
</div>
<a name="skip-navbar_top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="subTitle">org.transitime.statistics</div>
<h2 title="Class ScheduleDataProcessor" class="title">Class ScheduleDataProcessor</h2>
</div>
<div class="contentContainer">
<ul class="inheritance">
<li>java.lang.Object</li>
<li>
<ul class="inheritance">
<li>org.transitime.statistics.ScheduleDataProcessor</li>
</ul>
</li>
</ul>
<div class="description">
<ul class="blockList">
<li class="blockList">
<hr>
<br>
<pre>public class <span class="strong">ScheduleDataProcessor</span>
extends java.lang.Object</pre>
<div class="block">For processing arrival/departure times based on AVL data in order to
 determine more accurate schedule information. The results are output into new
 stop_times GTFS files. Data is handled on a per trip basis. This means that
 for regular schedule based systems that run a trip only once per day you need
 several days of data to get multiple data points. But for frequency based
 configurations where a trip is run multiple times a day each run of that trip
 for the day is processed into a single value.
 <p>
 This class also processes schedule adherence information so one can determine
 what the schedule adherence was with the old stop_times and what it would be
 with the new ones. This allows one to see directly what kind of improvement
 using the new stop_times will provide. The schedule adherence information is
 included in the log file, not in the new stop_times files.
 <p>
 The results are output into the original GTFS directory as two new stop times
 files: stop_times.txt_new and stop_times.txt_extended. Note that the original
 stop_times.txt file will not be overwritten. If you want to use the new
 stop_times.txt_new file you need to change its name to stop_times.txt,
 thereby overwriting the old file.
 <p>
 The stop_times.txt_new file has exactly the same format as the standard
 stop_times.txt file. The stop_times.txt_extended file contains the standard
 data but also adds some very useful columns including the original stop time
 so you can see how much it is being changed, the min and max arrival &
 departure times, the standard deviation so you can see the distribution of
 times, and the number of data points so you can see how many trips were used
 to generate the values.
 <p>
 The order of the rows in the new stop_times files will not necessarily be the
 same as the original stop_times file. If the ordering of the original
 stop_times file is adequate such that trips are grouped together and that the
 stop_sequence increases within the trip, then the new stop_times files can
 have the same order. But if there are issues with the ordering of the data in
 the original stop_times file, which is somewhat common, then the data is
 first sorted so that can determine the first stops of trips, which is
 important for the GTFS data is frequency based. This leads to a different
 ordering for the stop_times.txt_new and stop_times.txt_extended files.
 <p>
 To process the data this class reads in arrival and departure data from the
 database. It batch reads the data 500,000 datapoints at a time, a value
 chosen to make db reading quick (want a high number) without using too much
 heap memory at once (want a low number). The arrivals and departures data is
 read into maps
 <code>Map&ltString, Map&ltTripStopKey, List&ltInteger&gt&gt&gt</code> using
 <code>readInArrivalsOrDeparturesFromDb()</code>. The map is keyed on routeId
 so that can handle each route separately (though this isn't truly needed).
 The data is simply stored as Integers indicating the time of day of the
 arrival or departure. Once this data is determined the ArrivalDeparture
 object is not needed anymore and can be garbage collected. When reading in
 departures it also puts the trip departure times into
 departureTimesFromTerminalMap so that can determine elapsed time for when
 frequency based trips are used.
 <p>
 Once all of the arrival and departure times have been processed into a map
 statistics is used to determine which is the best arrival/departure for the
 stop_times output. The goal is to use a time such that only the a desired
 fraction of arrivals/departures will be early. For example, if you want only
 20% of the vehicle to be early with respect to the schedule time, which is
 reasonable because for passengers it is better for vehicles to be late rather
 then early so they don't miss the vehicle, then the value should be 0.2. This
 desiredFractionEarly value is specified when the ScheduleDataProcessor object is
 constructed.
 <p>
 The way the software tries to achieve the desiredFractionEarly is by assuming
 there is a Gaussian distribution of the times. By using the standard
 deviation of a Gaussian distribution the software estimates the value to use
 to such that desiredFractionEarly will be attained. Of course the
 distribution is not truly Gaussian. Therefore several iterations are used to
 adjust the value in order to get the desired results.
 <p>
 The results are then output into the stop_times.txt_new and
 stop_times.txt_extended files described above.</div>
<dl><dt><span class="strong">Author:</span></dt>
  <dd>SkiBu Smith</dd></dl>
</li>
</ul>
</div>
<div class="summary">
<ul class="blockList">
<li class="blockList">
<!-- ======== NESTED CLASS SUMMARY ======== -->
<ul class="blockList">
<li class="blockList"><a name="nested_class_summary">
<!--   -->
</a>
<h3>Nested Class Summary</h3>
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Nested Class Summary table, listing nested classes, and an explanation">
<caption><span>Nested Classes</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Class and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>static class&nbsp;</code></td>
<td class="colLast"><code><strong><a href="../../../org/transitime/statistics/ScheduleDataProcessor.TerminalDeparturesKey.html" title="class in org.transitime.statistics">ScheduleDataProcessor.TerminalDeparturesKey</a></strong></code>
<div class="block">Special MapKey class so that can make sure using the proper key for the
 departureTimesFromTerminalMap map in this class.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>static class&nbsp;</code></td>
<td class="colLast"><code><strong><a href="../../../org/transitime/statistics/ScheduleDataProcessor.TripStopKey.html" title="class in org.transitime.statistics">ScheduleDataProcessor.TripStopKey</a></strong></code>
<div class="block">Special MapKey class so that can make sure using the proper key for the
 several maps in this class.</div>
</td>
</tr>
</table>
</li>
</ul>
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<ul class="blockList">
<li class="blockList"><a name="constructor_summary">
<!--   -->
</a>
<h3>Constructor Summary</h3>
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Constructor Summary table, listing constructors, and an explanation">
<caption><span>Constructors</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colOne" scope="col">Constructor and Description</th>
</tr>
<tr class="altColor">
<td class="colOne"><code><strong><a href="../../../org/transitime/statistics/ScheduleDataProcessor.html#ScheduleDataProcessor(java.lang.String, java.lang.String, java.util.Date, java.util.Date, org.transitime.utils.Time, double, int, int, boolean, int, int)">ScheduleDataProcessor</a></strong>(java.lang.String&nbsp;projectId,
                     java.lang.String&nbsp;gtfsDirectoryName,
                     java.util.Date&nbsp;beginTime,
                     java.util.Date&nbsp;endTime,
                     <a href="../../../org/transitime/utils/Time.html" title="class in org.transitime.utils">Time</a>&nbsp;timeForUsingCalendar,
                     double&nbsp;desiredFractionEarly,
                     int&nbsp;allowableDifferenceFromMeanSecs,
                     int&nbsp;allowableDifferenceFromOriginalTimeSecs,
                     boolean&nbsp;doNotUpdateFirstStopOfTrip,
                     int&nbsp;allowableEarlySecs,
                     int&nbsp;allowableLateSecs)</code>&nbsp;</td>
</tr>
</table>
</li>
</ul>
<!-- ========== METHOD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="method_summary">
<!--   -->
</a>
<h3>Method Summary</h3>
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Method Summary table, listing methods, and an explanation">
<caption><span>Methods</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Method and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>static <a href="../../../org/transitime/statistics/ScheduleDataProcessor.TripStopKey.html" title="class in org.transitime.statistics">ScheduleDataProcessor.TripStopKey</a></code></td>
<td class="colLast"><code><strong><a href="../../../org/transitime/statistics/ScheduleDataProcessor.html#getTripStopKey(java.lang.String, java.lang.String)">getTripStopKey</a></strong>(java.lang.String&nbsp;tripId,
              java.lang.String&nbsp;stopId)</code>
<div class="block">For use in the sub-maps of arrivalTimesFromDbByRouteByTripStopMap and
 departureTimesFromDbByRouteByTripStopMap.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>void</code></td>
<td class="colLast"><code><strong><a href="../../../org/transitime/statistics/ScheduleDataProcessor.html#process()">process</a></strong>()</code>
<div class="block">Reads original stop_times.txt file, reads in arrival/departures from the
 database, processes the arrival/departure info to determine more accurate
 schedule times, and writes the results to new stop_times files.</div>
</td>
</tr>
</table>
<ul class="blockList">
<li class="blockList"><a name="methods_inherited_from_class_java.lang.Object">
<!--   -->
</a>
<h3>Methods inherited from class&nbsp;java.lang.Object</h3>
<code>equals, getClass, hashCode, notify, notifyAll, toString, wait, wait, wait</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="details">
<ul class="blockList">
<li class="blockList">
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<ul class="blockList">
<li class="blockList"><a name="constructor_detail">
<!--   -->
</a>
<h3>Constructor Detail</h3>
<a name="ScheduleDataProcessor(java.lang.String, java.lang.String, java.util.Date, java.util.Date, org.transitime.utils.Time, double, int, int, boolean, int, int)">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>ScheduleDataProcessor</h4>
<pre>public&nbsp;ScheduleDataProcessor(java.lang.String&nbsp;projectId,
                     java.lang.String&nbsp;gtfsDirectoryName,
                     java.util.Date&nbsp;beginTime,
                     java.util.Date&nbsp;endTime,
                     <a href="../../../org/transitime/utils/Time.html" title="class in org.transitime.utils">Time</a>&nbsp;timeForUsingCalendar,
                     double&nbsp;desiredFractionEarly,
                     int&nbsp;allowableDifferenceFromMeanSecs,
                     int&nbsp;allowableDifferenceFromOriginalTimeSecs,
                     boolean&nbsp;doNotUpdateFirstStopOfTrip,
                     int&nbsp;allowableEarlySecs,
                     int&nbsp;allowableLateSecs)</pre>
<dl><dt><span class="strong">Parameters:</span></dt><dd><code>projectId</code> - </dd><dd><code>gtfsDirectoryName</code> - </dd><dd><code>beginTime</code> - </dd><dd><code>endTime</code> - </dd><dd><code>timeForUsingCalendar</code> - </dd><dd><code>desiredFractionEarly</code> - how many arrival/departures should be early</dd><dd><code>allowableDifferenceFromMeanSecs</code> - </dd><dd><code>allowableDifferenceFromOriginalTimeSecs</code> - </dd><dd><code>doNotUpdateFirstStopOfTrip</code> - </dd><dd><code>allowableEarlySecs</code> - </dd><dd><code>allowableLateSecs</code> - </dd></dl>
</li>
</ul>
</li>
</ul>
<!-- ============ METHOD DETAIL ========== -->
<ul class="blockList">
<li class="blockList"><a name="method_detail">
<!--   -->
</a>
<h3>Method Detail</h3>
<a name="getTripStopKey(java.lang.String, java.lang.String)">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>getTripStopKey</h4>
<pre>public static&nbsp;<a href="../../../org/transitime/statistics/ScheduleDataProcessor.TripStopKey.html" title="class in org.transitime.statistics">ScheduleDataProcessor.TripStopKey</a>&nbsp;getTripStopKey(java.lang.String&nbsp;tripId,
                                               java.lang.String&nbsp;stopId)</pre>
<div class="block">For use in the sub-maps of arrivalTimesFromDbByRouteByTripStopMap and
 departureTimesFromDbByRouteByTripStopMap.
 
 The key is simply tripId + stopId. Previously used tripId + "=" + stopId
 but trying to make things as efficient as possible. This might not
 actually be a good idea since it could make debugging a bit more
 difficult.</div>
<dl><dt><span class="strong">Parameters:</span></dt><dd><code>tripId</code> - </dd><dd><code>stopId</code> - </dd>
<dt><span class="strong">Returns:</span></dt><dd></dd></dl>
</li>
</ul>
<a name="process()">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>process</h4>
<pre>public&nbsp;void&nbsp;process()</pre>
<div class="block">Reads original stop_times.txt file, reads in arrival/departures from the
 database, processes the arrival/departure info to determine more accurate
 schedule times, and writes the results to new stop_times files.
 <p>
 For each trip/stop in the stop_times.txt file sees if there is AVL based
 arrival/departure times. If there is then it is used when creating
 GtfsExtendedStopTime object. If no data for the trip/stop then null
 values will be used. The result GtfsExtendedStopTimes are then written to
 two files: - stop_times.txt_new which uses the standard GTFS format -
 stop_times.txt_extended which has additional info such as standard
 deviation.</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<!-- ========= END OF CLASS DATA ========= -->
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar_bottom">
<!--   -->
</a><a href="#skip-navbar_bottom" title="Skip navigation links"></a><a name="navbar_bottom_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/ScheduleDataProcessor.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../org/transitime/statistics/MiscStatistics.html" title="class in org.transitime.statistics"><span class="strong">Prev Class</span></a></li>
<li><a href="../../../org/transitime/statistics/ScheduleDataProcessor.TerminalDeparturesKey.html" title="class in org.transitime.statistics"><span class="strong">Next Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../index.html?org/transitime/statistics/ScheduleDataProcessor.html" target="_top">Frames</a></li>
<li><a href="ScheduleDataProcessor.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li><a href="#nested_class_summary">Nested</a>&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#constructor_summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method_summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#constructor_detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method_detail">Method</a></li>
</ul>
</div>
<a name="skip-navbar_bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
</body>
</html>
